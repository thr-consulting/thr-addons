<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Documentation Source: mongoloader/src/MongoLoader.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.lumen.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Documentation</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="DateTimePicker.html">DateTimePicker</a></li><li><a href="Dialog.html">Dialog</a></li><li><a href="DialogButtons.html">DialogButtons</a></li><li><a href="DialogSystem.html">DialogSystem</a></li><li><a href="EpochDatePicker.html">EpochDatePicker</a></li><li><a href="FieldMap.html">FieldMap</a></li><li><a href="LocalDatePicker.html">LocalDatePicker</a></li><li><a href="LocalMonthSelect.html">LocalMonthSelect</a></li><li><a href="MaskedInput.html">MaskedInput</a></li><li><a href="MomentSchema.html">MomentSchema</a></li><li><a href="MoneyInput.html">MoneyInput</a></li><li><a href="MoneyInputMask.html">MoneyInputMask</a></li><li><a href="MoneySchema.html">MoneySchema</a></li><li><a href="MongoLoader.html">MongoLoader</a></li><li><a href="MonthSelect.html">MonthSelect</a></li><li><a href="RadioGroup.html">RadioGroup</a></li><li><a href="ResponsiveMenu.html">ResponsiveMenu</a></li><li><a href="RouteDirector.html">RouteDirector</a></li><li><a href="SField.html">SField</a></li><li><a href="SForm.html">SForm</a></li><li><a href="SFormSummary.html">SFormSummary</a></li><li><a href="SinEntry.html">SinEntry</a></li><li><a href="TForm.html">TForm</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#addErrorMessage">addErrorMessage</a></li><li><a href="global.html#addNotification">addNotification</a></li><li><a href="global.html#address">address</a></li><li><a href="global.html#addSuccessMessage">addSuccessMessage</a></li><li><a href="global.html#addWarnMessage">addWarnMessage</a></li><li><a href="global.html#checkPermissions">checkPermissions</a></li><li><a href="global.html#CLEAR_MESSAGES">CLEAR_MESSAGES</a></li><li><a href="global.html#clearAllMessages">clearAllMessages</a></li><li><a href="global.html#clearMessage">clearMessage</a></li><li><a href="global.html#clearMessages">clearMessages</a></li><li><a href="global.html#dateInit">dateInit</a></li><li><a href="global.html#email">email</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatMoney">formatMoney</a></li><li><a href="global.html#getCountryCode">getCountryCode</a></li><li><a href="global.html#localDate">localDate</a></li><li><a href="global.html#localDateNumber">localDateNumber</a></li><li><a href="global.html#location">location</a></li><li><a href="global.html#makeMoney">makeMoney</a></li><li><a href="global.html#mapEpochIntegerToLocalDates">mapEpochIntegerToLocalDates</a></li><li><a href="global.html#moment">moment</a></li><li><a href="global.html#money">money</a></li><li><a href="global.html#password">password</a></li><li><a href="global.html#passwordSecond">passwordSecond</a></li><li><a href="global.html#phone">phone</a></li><li><a href="global.html#reactElements">reactElements</a></li><li><a href="global.html#removeNotification">removeNotification</a></li><li><a href="global.html#roundTo">roundTo</a></li><li><a href="global.html#schemaValidate">schemaValidate</a></li><li><a href="global.html#sFieldMessages">sFieldMessages</a></li><li><a href="global.html#transformDatesToMoment">transformDatesToMoment</a></li><li><a href="global.html#transformDateToEpochInteger">transformDateToEpochInteger</a></li><li><a href="global.html#transformDateToLocalDate">transformDateToLocalDate</a></li><li><a href="global.html#transformEpochIntegerToDate">transformEpochIntegerToDate</a></li><li><a href="global.html#transformEpochIntegerToLocalDate">transformEpochIntegerToLocalDate</a></li><li><a href="global.html#transformLocalDatesToEpochInteger">transformLocalDatesToEpochInteger</a></li><li><a href="global.html#transformLocalDateToDate">transformLocalDateToDate</a></li><li><a href="global.html#transformLocalDateToEpochInteger">transformLocalDateToEpochInteger</a></li><li><a href="global.html#transformLocalDateToMoment">transformLocalDateToMoment</a></li><li><a href="global.html#transformMomentsToDate">transformMomentsToDate</a></li><li><a href="global.html#transformMomentToLocalDate">transformMomentToLocalDate</a></li><li><a href="global.html#transformObjectsToLocalDates">transformObjectsToLocalDates</a></li><li><a href="global.html#transformObjectsToMoney">transformObjectsToMoney</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: mongoloader/src/MongoLoader.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/* eslint-disable lines-between-class-members */
import debug from 'debug';
import DataLoader from 'dataloader';
import isArray from 'lodash/isArray';
import get from 'lodash/get';

const d = debug('thx:mongoloader:MongoLoader');

/**
 * Extend this class to give DataLoader caching and batching power to your Mongo collection.
 * When creating loaders on properties, make sure each property is indexed for performance reasons.
 */
export default class MongoLoader {
	constructor(db, ctx, collectionName, options) {
		// Protected members
		this.ctx = ctx;

		// Private members
		this._collectionName = collectionName;
		this._collection = db.collection(collectionName);
		this._dataloaders = {};

		// Create default loader which loads by _id
		this.createLoader('_id', options);
	}

	/**
	 * Returns the contexts models. Shortcut for this.ctx.models.
	 * @return {{testModel: string}|ctx._models|{testModel}}
	 */
	get models() {
		return this.ctx._models; /* eslint-disable-line no-underscore-dangle */
	}

	/**
	 * Ensure the order of batch loaded objects
	 * Written by lukejagodzinski: https://github.com/facebook/dataloader/issues/66#issuecomment-386252044
	 * @param docs
	 * @param keys
	 * @param prop
	 * @param error Function that takes a key and should return an error string
	 */
	static ensureOrder({docs, keys, prop, error}) {
		// Put documents (docs) into a map where key is a document's ID or some
		// property (prop) of a document and value is a document.
		const docsMap = new Map();
		docs.forEach(doc => docsMap.set(get(doc, prop), doc));

		return keys.map(key => docsMap.get(key) || error(key));

		// Loop through the keys and for each one retrieve proper document. For not
		// existing documents generate an error.
		// return keys.map(key => docsMap.get(key) || new Error(error(key)));
	}

	/**
	 * Return a function that finds Mongo records based off of a certain key. Ensures correct order and primes the
	 * other dataloaders as well.
	 * @param key The dataloader key which corresponds to the document property
	 * @param errorFunc
	 * @returns {function(*=)}
	 * @private
	 */
	_findBy = (key, errorFunc = () => undefined) => async keys => {
		d(`Fetching from ${this._collectionName}: ${keys}`);

		const docsI = await this._collection.find({[key]: {$in: keys}}).toArray();

		// Fetch the documents from Mongo and ensure the same order as keys
		const docs = MongoLoader.ensureOrder({
			docs: docsI,
			keys,
			prop: key,
			error: errorFunc,
		});

		// For each other dataloader, prime with returned documents
		Object.keys(this._dataloaders).forEach(dataloader => {
			if (key === dataloader) return; // Don't prime current dataloader
			docs.forEach(doc => {
				if (doc &amp;&amp; !(doc instanceof Error)) this._dataloaders[dataloader].prime(doc[dataloader], doc);
			});
		});

		return docs;
	};

	/**
	 * Creates a new dataloader which loads on a specific document property
	 * @param key The document key
	 * @param options Dataloader options
	 */
	createLoader = (key, options) => {
		this._dataloaders[key] = new DataLoader(this._findBy(key, options ? options.errorFunc : undefined), options);
	};

	/**
	 * Loads a single document by specific property from a dataloader.
	 * @param key The key value
	 * @param dataloader Document property to load from
	 */
	load = (key, dataloader = '_id') => this._dataloaders[dataloader].load(key);

	/**
	 * Loads multiple documents by a specific property from a dataloader.
	 * @param keys The key value array
	 * @param dataloader Document property to load from
	 * @returns {*}
	 */
	loadMany = (keys, dataloader = '_id') => this._dataloaders[dataloader].loadMany(keys);

	/**
	 * Clears a single document from all dataloaders.
	 * @param doc
	 */
	clear = doc => {
		Object.keys(this._dataloaders).forEach(dataloader => {
			this._dataloaders[dataloader].clear(doc[dataloader]);
		});
	};

	/**
	 * Clears all documents from all dataloaders.
	 */
	clearAll = () => {
		Object.keys(this._dataloaders).forEach(dataloader => {
			this._dataloaders[dataloader].clearAll();
		});
	};

	/**
	 * Prime all dataloaders with a document or documents. Returns the document for convenience.
	 * @param doc Either a single document or an array of documents.
	 * @return {*}
	 */
	prime = doc => {
		if (doc) {
			Object.keys(this._dataloaders).forEach(dataloader => {
				if (isArray(doc)) {
					doc.forEach(oneDoc => this._dataloaders[dataloader].prime(get(oneDoc, dataloader), oneDoc));
				} else {
					this._dataloaders[dataloader].prime(get(doc, dataloader), doc);
				}
			});
		}
		return doc;
	};

	// Direct Mongo methods. These bypass the dataloader (no caching or batching).
	count = (query, options) => this._collection.count(query, options);
	createIndex = (fieldOrSpec, options) => this._collection.createIndex(fieldOrSpec, options);
	createIndexes = (indexSpecs, options) => this._collection.createIndexes(indexSpecs, options);
	deleteMany = (filter, options) => this._collection.deleteMany(filter, options);
	deleteOne = (filter, options) => this._collection.deleteOne(filter, options);
	distinct = (key, query, options) => this._collection.distinct(key, query, options);
	drop = options => this._collection.drop(options);
	find = (query, options) => this._collection.find(query, options);
	findOne = (query, options) => this._collection.findOne(query, options);
	findOneAndDelete = (query, options) => this._collection.findOneAndDelete(query, options);
	findOneAndReplace = (query, replacement, options) => this._collection.findOneAndReplace(query, replacement, options);
	findOneAndUpdate = (query, update, options) => this._collection.findOneAndUpdate(query, update, options);
	insertMany = (docs, options) => this._collection.insertMany(docs, options);
	insertOne = (doc, options) => this._collection.insertOne(doc, options);
	replaceOne = (query, doc, options) => this._collection.replaceOne(query, doc, options);
	updateMany = (query, update, options) => this._collection.updateMany(query, update, options);
	updateOne = (query, update, options) => this._collection.update(query, update, options);
}
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
	
		on 2018-06-15T16:36:55-05:00
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
